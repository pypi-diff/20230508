# Comparing `tmp/nucliadb_utils-2.8.5.post247-py3-none-any.whl.zip` & `tmp/nucliadb_utils-2.8.5.post249-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,70 +1,71 @@
-Zip file size: 97680 bytes, number of entries: 68
--rw-r--r--  2.0 unx      895 b- defN 23-May-08 15:32 nucliadb_utils/__init__.py
--rw-r--r--  2.0 unx     5877 b- defN 23-May-08 15:32 nucliadb_utils/authentication.py
--rw-r--r--  2.0 unx     4518 b- defN 23-May-08 15:32 nucliadb_utils/clandestined.py
--rw-r--r--  2.0 unx     1022 b- defN 23-May-08 15:32 nucliadb_utils/const.py
--rw-r--r--  2.0 unx     1138 b- defN 23-May-08 15:32 nucliadb_utils/exceptions.py
--rw-r--r--  2.0 unx     2130 b- defN 23-May-08 15:32 nucliadb_utils/featureflagging.py
--rw-r--r--  2.0 unx     2212 b- defN 23-May-08 15:32 nucliadb_utils/grpc.py
--rw-r--r--  2.0 unx     3572 b- defN 23-May-08 15:32 nucliadb_utils/indexing.py
--rw-r--r--  2.0 unx      867 b- defN 23-May-08 15:32 nucliadb_utils/keys.py
--rw-r--r--  2.0 unx     1519 b- defN 23-May-08 15:32 nucliadb_utils/nats.py
--rw-r--r--  2.0 unx     1173 b- defN 23-May-08 15:32 nucliadb_utils/partition.py
--rw-r--r--  2.0 unx        0 b- defN 23-May-08 15:32 nucliadb_utils/py.typed
--rw-r--r--  2.0 unx     1713 b- defN 23-May-08 15:32 nucliadb_utils/run.py
--rw-r--r--  2.0 unx     5028 b- defN 23-May-08 15:32 nucliadb_utils/settings.py
--rw-r--r--  2.0 unx      890 b- defN 23-May-08 15:32 nucliadb_utils/store.py
--rw-r--r--  2.0 unx     6131 b- defN 23-May-08 15:32 nucliadb_utils/transaction.py
--rw-r--r--  2.0 unx    11358 b- defN 23-May-08 15:32 nucliadb_utils/utilities.py
--rw-r--r--  2.0 unx      835 b- defN 23-May-08 15:32 nucliadb_utils/audit/__init__.py
--rw-r--r--  2.0 unx     2013 b- defN 23-May-08 15:32 nucliadb_utils/audit/audit.py
--rw-r--r--  2.0 unx     2446 b- defN 23-May-08 15:32 nucliadb_utils/audit/basic.py
--rw-r--r--  2.0 unx     7688 b- defN 23-May-08 15:32 nucliadb_utils/audit/stream.py
--rw-r--r--  2.0 unx      900 b- defN 23-May-08 15:32 nucliadb_utils/cache/__init__.py
--rw-r--r--  2.0 unx      975 b- defN 23-May-08 15:32 nucliadb_utils/cache/exceptions.py
--rw-r--r--  2.0 unx     1216 b- defN 23-May-08 15:32 nucliadb_utils/cache/memcache.py
--rw-r--r--  2.0 unx     7089 b- defN 23-May-08 15:32 nucliadb_utils/cache/nats.py
--rw-r--r--  2.0 unx     1654 b- defN 23-May-08 15:32 nucliadb_utils/cache/pubsub.py
--rw-r--r--  2.0 unx     3110 b- defN 23-May-08 15:32 nucliadb_utils/cache/redis.py
--rw-r--r--  2.0 unx     1302 b- defN 23-May-08 15:32 nucliadb_utils/cache/settings.py
--rw-r--r--  2.0 unx     5906 b- defN 23-May-08 15:32 nucliadb_utils/cache/utility.py
--rw-r--r--  2.0 unx      833 b- defN 23-May-08 15:32 nucliadb_utils/fastapi/__init__.py
--rw-r--r--  2.0 unx     1737 b- defN 23-May-08 15:32 nucliadb_utils/fastapi/openapi.py
--rw-r--r--  2.0 unx     3631 b- defN 23-May-08 15:32 nucliadb_utils/fastapi/run.py
--rw-r--r--  2.0 unx     3786 b- defN 23-May-08 15:32 nucliadb_utils/fastapi/versioning.py
--rw-r--r--  2.0 unx      855 b- defN 23-May-08 15:32 nucliadb_utils/storages/__init__.py
--rw-r--r--  2.0 unx     2274 b- defN 23-May-08 15:32 nucliadb_utils/storages/exceptions.py
--rw-r--r--  2.0 unx    24880 b- defN 23-May-08 15:32 nucliadb_utils/storages/gcs.py
--rw-r--r--  2.0 unx    10180 b- defN 23-May-08 15:32 nucliadb_utils/storages/local.py
--rw-r--r--  2.0 unx     2093 b- defN 23-May-08 15:32 nucliadb_utils/storages/nuclia.py
--rw-r--r--  2.0 unx    17174 b- defN 23-May-08 15:32 nucliadb_utils/storages/pg.py
--rw-r--r--  2.0 unx    15029 b- defN 23-May-08 15:32 nucliadb_utils/storages/s3.py
--rw-r--r--  2.0 unx     1276 b- defN 23-May-08 15:32 nucliadb_utils/storages/settings.py
--rw-r--r--  2.0 unx    17691 b- defN 23-May-08 15:32 nucliadb_utils/storages/storage.py
--rw-r--r--  2.0 unx      833 b- defN 23-May-08 15:32 nucliadb_utils/tests/__init__.py
--rw-r--r--  2.0 unx    10691 b- defN 23-May-08 15:32 nucliadb_utils/tests/asyncbenchmark.py
--rw-r--r--  2.0 unx     1043 b- defN 23-May-08 15:32 nucliadb_utils/tests/clandestined.py
--rw-r--r--  2.0 unx     1686 b- defN 23-May-08 15:32 nucliadb_utils/tests/conftest.py
--rw-r--r--  2.0 unx     2758 b- defN 23-May-08 15:32 nucliadb_utils/tests/gcs.py
--rw-r--r--  2.0 unx     2307 b- defN 23-May-08 15:32 nucliadb_utils/tests/indexing.py
--rw-r--r--  2.0 unx     1310 b- defN 23-May-08 15:32 nucliadb_utils/tests/local.py
--rw-r--r--  2.0 unx     7699 b- defN 23-May-08 15:32 nucliadb_utils/tests/nats.py
--rw-r--r--  2.0 unx     2216 b- defN 23-May-08 15:32 nucliadb_utils/tests/s3.py
--rw-r--r--  2.0 unx      833 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/__init__.py
--rw-r--r--  2.0 unx     5159 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/test_authentication.py
--rw-r--r--  2.0 unx    14507 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/test_clandestined.py
--rw-r--r--  2.0 unx     1949 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/test_clandestined_collision.py
--rw-r--r--  2.0 unx     5303 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
--rw-r--r--  2.0 unx     1910 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/test_run.py
--rw-r--r--  2.0 unx     1189 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/test_tests.py
--rw-r--r--  2.0 unx     3435 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/test_transaction.py
--rw-r--r--  2.0 unx     5277 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/test_utilities.py
--rw-r--r--  2.0 unx      833 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/storages/__init__.py
--rw-r--r--  2.0 unx    16726 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/storages/test_pg.py
--rw-r--r--  2.0 unx     5638 b- defN 23-May-08 15:32 nucliadb_utils/tests/unit/storages/test_storage.py
--rw-r--r--  2.0 unx     1776 b- defN 23-May-08 15:33 nucliadb_utils-2.8.5.post247.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-May-08 15:33 nucliadb_utils-2.8.5.post247.dist-info/WHEEL
--rw-r--r--  2.0 unx       15 b- defN 23-May-08 15:33 nucliadb_utils-2.8.5.post247.dist-info/top_level.txt
--rw-r--r--  2.0 unx        1 b- defN 23-May-08 15:32 nucliadb_utils-2.8.5.post247.dist-info/zip-safe
--rw-rw-r--  2.0 unx     6113 b- defN 23-May-08 15:33 nucliadb_utils-2.8.5.post247.dist-info/RECORD
-68 files, 287915 bytes uncompressed, 87884 bytes compressed:  69.5%
+Zip file size: 100700 bytes, number of entries: 69
+-rw-r--r--  2.0 unx      895 b- defN 23-May-08 19:19 nucliadb_utils/__init__.py
+-rw-r--r--  2.0 unx     5877 b- defN 23-May-08 19:19 nucliadb_utils/authentication.py
+-rw-r--r--  2.0 unx     4518 b- defN 23-May-08 19:19 nucliadb_utils/clandestined.py
+-rw-r--r--  2.0 unx     1790 b- defN 23-May-08 19:19 nucliadb_utils/const.py
+-rw-r--r--  2.0 unx     1138 b- defN 23-May-08 19:19 nucliadb_utils/exceptions.py
+-rw-r--r--  2.0 unx     2262 b- defN 23-May-08 19:19 nucliadb_utils/featureflagging.py
+-rw-r--r--  2.0 unx     2212 b- defN 23-May-08 19:19 nucliadb_utils/grpc.py
+-rw-r--r--  2.0 unx     3474 b- defN 23-May-08 19:19 nucliadb_utils/indexing.py
+-rw-r--r--  2.0 unx      867 b- defN 23-May-08 19:19 nucliadb_utils/keys.py
+-rw-r--r--  2.0 unx     5993 b- defN 23-May-08 19:19 nucliadb_utils/nats.py
+-rw-r--r--  2.0 unx     1173 b- defN 23-May-08 19:19 nucliadb_utils/partition.py
+-rw-r--r--  2.0 unx        0 b- defN 23-May-08 19:19 nucliadb_utils/py.typed
+-rw-r--r--  2.0 unx     1713 b- defN 23-May-08 19:19 nucliadb_utils/run.py
+-rw-r--r--  2.0 unx     4682 b- defN 23-May-08 19:19 nucliadb_utils/settings.py
+-rw-r--r--  2.0 unx      890 b- defN 23-May-08 19:19 nucliadb_utils/store.py
+-rw-r--r--  2.0 unx     6621 b- defN 23-May-08 19:19 nucliadb_utils/transaction.py
+-rw-r--r--  2.0 unx    13338 b- defN 23-May-08 19:19 nucliadb_utils/utilities.py
+-rw-r--r--  2.0 unx      835 b- defN 23-May-08 19:19 nucliadb_utils/audit/__init__.py
+-rw-r--r--  2.0 unx     2013 b- defN 23-May-08 19:19 nucliadb_utils/audit/audit.py
+-rw-r--r--  2.0 unx     2446 b- defN 23-May-08 19:19 nucliadb_utils/audit/basic.py
+-rw-r--r--  2.0 unx     7688 b- defN 23-May-08 19:19 nucliadb_utils/audit/stream.py
+-rw-r--r--  2.0 unx      900 b- defN 23-May-08 19:19 nucliadb_utils/cache/__init__.py
+-rw-r--r--  2.0 unx      975 b- defN 23-May-08 19:19 nucliadb_utils/cache/exceptions.py
+-rw-r--r--  2.0 unx     1216 b- defN 23-May-08 19:19 nucliadb_utils/cache/memcache.py
+-rw-r--r--  2.0 unx     7089 b- defN 23-May-08 19:19 nucliadb_utils/cache/nats.py
+-rw-r--r--  2.0 unx     1654 b- defN 23-May-08 19:19 nucliadb_utils/cache/pubsub.py
+-rw-r--r--  2.0 unx     3110 b- defN 23-May-08 19:19 nucliadb_utils/cache/redis.py
+-rw-r--r--  2.0 unx     1302 b- defN 23-May-08 19:19 nucliadb_utils/cache/settings.py
+-rw-r--r--  2.0 unx     5906 b- defN 23-May-08 19:19 nucliadb_utils/cache/utility.py
+-rw-r--r--  2.0 unx      833 b- defN 23-May-08 19:19 nucliadb_utils/fastapi/__init__.py
+-rw-r--r--  2.0 unx     1737 b- defN 23-May-08 19:19 nucliadb_utils/fastapi/openapi.py
+-rw-r--r--  2.0 unx     3631 b- defN 23-May-08 19:19 nucliadb_utils/fastapi/run.py
+-rw-r--r--  2.0 unx     3786 b- defN 23-May-08 19:19 nucliadb_utils/fastapi/versioning.py
+-rw-r--r--  2.0 unx      855 b- defN 23-May-08 19:19 nucliadb_utils/storages/__init__.py
+-rw-r--r--  2.0 unx     2274 b- defN 23-May-08 19:19 nucliadb_utils/storages/exceptions.py
+-rw-r--r--  2.0 unx    24880 b- defN 23-May-08 19:19 nucliadb_utils/storages/gcs.py
+-rw-r--r--  2.0 unx    10180 b- defN 23-May-08 19:19 nucliadb_utils/storages/local.py
+-rw-r--r--  2.0 unx     2093 b- defN 23-May-08 19:19 nucliadb_utils/storages/nuclia.py
+-rw-r--r--  2.0 unx    17174 b- defN 23-May-08 19:19 nucliadb_utils/storages/pg.py
+-rw-r--r--  2.0 unx    15029 b- defN 23-May-08 19:19 nucliadb_utils/storages/s3.py
+-rw-r--r--  2.0 unx     1276 b- defN 23-May-08 19:19 nucliadb_utils/storages/settings.py
+-rw-r--r--  2.0 unx    17691 b- defN 23-May-08 19:19 nucliadb_utils/storages/storage.py
+-rw-r--r--  2.0 unx      994 b- defN 23-May-08 19:19 nucliadb_utils/tests/__init__.py
+-rw-r--r--  2.0 unx    10691 b- defN 23-May-08 19:19 nucliadb_utils/tests/asyncbenchmark.py
+-rw-r--r--  2.0 unx     1043 b- defN 23-May-08 19:19 nucliadb_utils/tests/clandestined.py
+-rw-r--r--  2.0 unx     1686 b- defN 23-May-08 19:19 nucliadb_utils/tests/conftest.py
+-rw-r--r--  2.0 unx     2758 b- defN 23-May-08 19:19 nucliadb_utils/tests/gcs.py
+-rw-r--r--  2.0 unx     1513 b- defN 23-May-08 19:19 nucliadb_utils/tests/indexing.py
+-rw-r--r--  2.0 unx     1310 b- defN 23-May-08 19:19 nucliadb_utils/tests/local.py
+-rw-r--r--  2.0 unx     7699 b- defN 23-May-08 19:19 nucliadb_utils/tests/nats.py
+-rw-r--r--  2.0 unx     2216 b- defN 23-May-08 19:19 nucliadb_utils/tests/s3.py
+-rw-r--r--  2.0 unx      833 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/__init__.py
+-rw-r--r--  2.0 unx     5159 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_authentication.py
+-rw-r--r--  2.0 unx    14507 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_clandestined.py
+-rw-r--r--  2.0 unx     1949 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_clandestined_collision.py
+-rw-r--r--  2.0 unx     5303 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
+-rw-r--r--  2.0 unx     3083 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_nats.py
+-rw-r--r--  2.0 unx     1910 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_run.py
+-rw-r--r--  2.0 unx     1189 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_tests.py
+-rw-r--r--  2.0 unx     3408 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_transaction.py
+-rw-r--r--  2.0 unx     5277 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/test_utilities.py
+-rw-r--r--  2.0 unx      833 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/storages/__init__.py
+-rw-r--r--  2.0 unx    16726 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/storages/test_pg.py
+-rw-r--r--  2.0 unx     5638 b- defN 23-May-08 19:19 nucliadb_utils/tests/unit/storages/test_storage.py
+-rw-r--r--  2.0 unx     1816 b- defN 23-May-08 19:21 nucliadb_utils-2.8.5.post249.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-08 19:21 nucliadb_utils-2.8.5.post249.dist-info/WHEEL
+-rw-r--r--  2.0 unx       15 b- defN 23-May-08 19:21 nucliadb_utils-2.8.5.post249.dist-info/top_level.txt
+-rw-r--r--  2.0 unx        1 b- defN 23-May-08 19:20 nucliadb_utils-2.8.5.post249.dist-info/zip-safe
+-rw-rw-r--  2.0 unx     6208 b- defN 23-May-08 19:21 nucliadb_utils-2.8.5.post249.dist-info/RECORD
+69 files, 297873 bytes uncompressed, 90752 bytes compressed:  69.5%
```

## zipnote {}

```diff
@@ -162,14 +162,17 @@
 
 Filename: nucliadb_utils/tests/unit/test_clandestined_collision.py
 Comment: 
 
 Filename: nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
 Comment: 
 
+Filename: nucliadb_utils/tests/unit/test_nats.py
+Comment: 
+
 Filename: nucliadb_utils/tests/unit/test_run.py
 Comment: 
 
 Filename: nucliadb_utils/tests/unit/test_tests.py
 Comment: 
 
 Filename: nucliadb_utils/tests/unit/test_transaction.py
@@ -183,23 +186,23 @@
 
 Filename: nucliadb_utils/tests/unit/storages/test_pg.py
 Comment: 
 
 Filename: nucliadb_utils/tests/unit/storages/test_storage.py
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post247.dist-info/METADATA
+Filename: nucliadb_utils-2.8.5.post249.dist-info/METADATA
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post247.dist-info/WHEEL
+Filename: nucliadb_utils-2.8.5.post249.dist-info/WHEEL
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post247.dist-info/top_level.txt
+Filename: nucliadb_utils-2.8.5.post249.dist-info/top_level.txt
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post247.dist-info/zip-safe
+Filename: nucliadb_utils-2.8.5.post249.dist-info/zip-safe
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post247.dist-info/RECORD
+Filename: nucliadb_utils-2.8.5.post249.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## nucliadb_utils/const.py

```diff
@@ -17,10 +17,41 @@
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 #
 class PubSubChannels:
     RESOURCE_NOTIFY = "notify.{kbid}"
 
 
+class Streams:
+    class INGEST:
+        """
+        Writing resource changes go to this steam/consumer group.
+        """
+
+        name = "nucliadb"
+        subject = "ndb.consumer.{partition}"
+        group = "nucliadb-{partition}"
+
+    class INGEST_PROCESSED:
+        """
+        Resources that have been processed by learning need to be
+        written to the database and then Indexed.
+        """
+
+        name = "nucliadb"
+        subject = "ndb.consumer.processed"
+        group = "nucliadb-processed"
+
+    class INDEX:
+        """
+        Indexing resources on the IndexNode
+        """
+
+        name = "node"
+        subject = "node.{node}"
+        group = "node-{node}"
+
+
 class Features:
     WAIT_FOR_INDEX = "nucliadb_wait_for_resource_index"
     SEEK_TO_PARAGRAPH = "nucliadb_seek_to_paragraph"
+    SEPARATE_PROCESSED_MESSAGE_WRITES = "nucliadb_separate_processed_message_writes"
```

## nucliadb_utils/featureflagging.py

```diff
@@ -39,14 +39,18 @@
         "rollout": 0,
         "variants": {"environment": ["stage"]},
     },
     const.Features.WAIT_FOR_INDEX: {
         "rollout": 0,
         "variants": {"environment": ["none"]},
     },
+    const.Features.SEPARATE_PROCESSED_MESSAGE_WRITES: {
+        "rollout": 0,
+        "variants": {"environment": ["none"]},
+    },
 }
 
 
 class FlagService:
     def __init__(self):
         self.settings = Settings()
         if self.settings.flag_settings_url is None:
```

## nucliadb_utils/indexing.py

```diff
@@ -21,32 +21,30 @@
 
 import nats
 from nats.aio.client import Client
 from nats.js.client import JetStreamContext
 from nucliadb_protos.nodewriter_pb2 import IndexMessage  # type: ignore
 from nucliadb_telemetry.jetstream import JetStreamContextTelemetry
 
-from nucliadb_utils import logger
+from nucliadb_utils import const, logger
 from nucliadb_utils.nats import get_traced_jetstream
 
 
 class IndexingUtility:
     nc: Optional[Client] = None
     js: Optional[Union[JetStreamContext, JetStreamContextTelemetry]] = None
 
     def __init__(
         self,
         nats_servers: List[str],
-        nats_target: str,
         nats_creds: Optional[str] = None,
         dummy: bool = False,
     ):
         self.nats_creds = nats_creds
         self.nats_servers = nats_servers
-        self.nats_target = nats_target
         self.dummy = dummy
         self._calls: List[Tuple[str, IndexMessage]] = []
 
     async def disconnected_cb(self):
         logger.info("Got disconnected from NATS!")
 
     async def reconnected_cb(self):
@@ -88,17 +86,16 @@
             self.nc = None
 
     async def index(self, writer: IndexMessage, node: str) -> int:
         if self.dummy:
             self._calls.append((node, writer))
             return 0
 
-        if self.js is None or self.nats_target is None:
+        if self.js is None:
             raise AttributeError()
 
-        res = await self.js.publish(
-            self.nats_target.format(node=node), writer.SerializeToString()
-        )
+        subject = const.Streams.INDEX.subject.format(node=node)
+        res = await self.js.publish(subject, writer.SerializeToString())
         logger.info(
-            f" - Pushed message to index {self.nats_target.format(node=node)}.  shard: {writer.shard}, txid: {writer.txid}  seqid: {res.seq}"  # noqa
+            f" - Pushed message to index {subject}.  shard: {writer.shard}, txid: {writer.txid}  seqid: {res.seq}"  # noqa
         )
         return res.seq
```

## nucliadb_utils/nats.py

```diff
@@ -13,25 +13,167 @@
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 
+import asyncio
 import logging
-
-from nats.aio.client import Client as NATS
+import time
+from functools import cached_property
+from typing import Any, Awaitable, Callable, Optional
+
+import nats
+import nats.errors
+import nats.js.api
+from nats.aio.client import Client as NATSClient
+from nats.aio.client import Msg
+from nats.aio.subscription import Subscription
 from nats.js.client import JetStreamContext
 from nucliadb_telemetry.jetstream import JetStreamContextTelemetry
 from nucliadb_telemetry.utils import get_telemetry
 
 logger = logging.getLogger(__name__)
 
 
-def get_traced_jetstream(nc: NATS, service_name: str) -> JetStreamContext:
+def get_traced_jetstream(nc: NATSClient, service_name: str) -> JetStreamContext:
     jetstream = nc.jetstream()
     tracer_provider = get_telemetry(service_name)
 
     if tracer_provider is not None and jetstream is not None:  # pragma: no cover
         logger.info(f"Configuring {service_name} jetstream with telemetry")
         jetstream = JetStreamContextTelemetry(jetstream, service_name, tracer_provider)
     return jetstream
+
+
+class NatsConnectionManager:
+    _nc: NATSClient
+    _subscriptions: list[tuple[Subscription, Callable[[], Awaitable[None]]]]
+    _unhealthy_timeout = (
+        10  # needs to be unhealth for 10 seconds to be unhealthy and force exit
+    )
+
+    def __init__(
+        self,
+        *,
+        service_name: str,
+        nats_servers: list[str],
+        nats_creds: Optional[str] = None,
+    ):
+        self._service_name = service_name
+        self._nats_servers = nats_servers
+        self._nats_creds = nats_creds
+        self._subscriptions = []
+        self._lock = asyncio.Lock()
+        self._healthy = True
+        self._last_unhealthy: Optional[float] = None
+
+    def healthy(self) -> bool:
+        if not self._healthy:
+            return False
+
+        if (
+            self._last_unhealthy is not None
+            and time.monotonic() - self._last_unhealthy > self._unhealthy_timeout
+        ):
+            return False
+
+        if not self._nc.is_connected:
+            self._last_unhealthy = time.monotonic()
+
+        return True
+
+    async def initialize(self) -> None:
+        options: dict[str, Any] = {
+            "error_cb": self.error_cb,
+            "closed_cb": self.closed_cb,
+            "reconnected_cb": self.reconnected_cb,
+            "disconnected_cb": self.disconnected_cb,
+        }
+
+        if self._nats_creds is not None:
+            options["user_credentials"] = self._nats_creds
+
+        if len(self._nats_servers) > 0:
+            options["servers"] = self._nats_servers
+
+        async with self._lock:
+            self._nc = await nats.connect(**options)
+
+    async def finalize(self):
+        async with self._lock:
+            for sub, _ in self._subscriptions:
+                try:
+                    await sub.drain()
+                except nats.errors.ConnectionClosedError:  # pragma: no cover
+                    pass
+            try:
+                await self.nc.drain()
+            except nats.errors.ConnectionClosedError:  # pragma: no cover
+                pass
+            await self.nc.close()
+            self._subscriptions = []
+
+    async def disconnected_cb(self) -> None:
+        logger.info("Disconnected from NATS!")
+        self._last_unhealthy = time.monotonic()
+
+    async def reconnected_cb(self):
+        # See who we are connected to on reconnect.
+        logger.warning(
+            f"Reconnected to NATS {self._nc.connected_url.netloc}. Attempting to re-subscribe."
+        )
+        async with self._lock:
+            existing_subs = self._subscriptions
+            self._subscriptions = []
+            for sub, recon_callback in existing_subs:
+                try:
+                    await sub.drain()
+                    await recon_callback()
+                except Exception:
+                    logger.exception(
+                        f"Error resubscribing to {sub.subject} on {self._nc.connected_url.netloc}"
+                    )
+                    # should force exit here to restart the service
+                    self._healthy = False
+                    raise
+        self._healthy = True
+        self._last_unhealthy = None  # reset the last unhealthy time
+
+    async def error_cb(self, e):  # pragma: no cover
+        logger.error(f"There was an error on consumer: {e}", exc_info=e)
+
+    async def closed_cb(self):  # pragma: no cover
+        logger.info("Connection is closed on NATS")
+
+    @property
+    def nc(self) -> NATSClient:
+        return self._nc
+
+    @cached_property
+    def js(self) -> JetStreamContext:
+        return get_traced_jetstream(self._nc, self._service_name)
+
+    async def subscribe(
+        self,
+        *,
+        subject: str,
+        queue: str,
+        stream: str,
+        cb: Callable[[Msg], Awaitable[None]],
+        subscription_lost_cb: Callable[[], Awaitable[None]],
+        flow_control: bool = False,
+        config: Optional[nats.js.api.ConsumerConfig] = None,
+    ) -> Subscription:
+        sub = await self.js.subscribe(
+            subject=subject,
+            queue=queue,
+            stream=stream,
+            cb=cb,
+            flow_control=flow_control,
+            config=config,
+        )
+
+        self._subscriptions.append((sub, subscription_lost_cb))
+
+        return sub
```

## nucliadb_utils/settings.py

```diff
@@ -128,27 +128,21 @@
 
 nucliadb_settings = NucliaDBSettings()
 
 
 class TransactionSettings(BaseSettings):
     transaction_jetstream_auth: Optional[str] = None
     transaction_jetstream_servers: List[str] = ["nats://localhost:4222"]
-    transaction_jetstream_target: str = "ndb.consumer.{partition}"
-    transaction_jetstream_group: str = "nucliadb-{partition}"
-    transaction_jetstream_stream: str = "nucliadb"
     transaction_local: bool = False
 
 
 transaction_settings = TransactionSettings()
 
 
 class IndexingSettings(BaseSettings):
-    index_jetstream_target: Optional[str] = "node.{node}"
-    index_jetstream_group: Optional[str] = "node-{node}"
-    index_jetstream_stream: Optional[str] = "node"
     index_jetstream_servers: List[str] = []
     index_jetstream_auth: Optional[str] = None
     index_local: bool = False
 
 
 indexing_settings = IndexingSettings()
```

## nucliadb_utils/transaction.py

```diff
@@ -42,15 +42,19 @@
     def __init__(self, uuid: str, seq: Optional[int] = None):
         self.uuid = uuid
         self.seq = seq
 
 
 class LocalTransactionUtility:
     async def commit(
-        self, writer: BrokerMessage, partition: int, wait: bool = False
+        self,
+        writer: BrokerMessage,
+        partition: int,
+        wait: bool = False,
+        target_subject: Optional[str] = None,
     ) -> int:
         from nucliadb_utils.utilities import get_ingest
 
         ingest = get_ingest()
 
         async def iterator(writer):
             yield writer
@@ -69,20 +73,18 @@
     nc: Client
     js: Union[JetStreamContext, JetStreamContextTelemetry]
     pubsub: PubSubDriver
 
     def __init__(
         self,
         nats_servers: List[str],
-        nats_target: str,
         nats_creds: Optional[str] = None,
     ):
         self.nats_creds = nats_creds
         self.nats_servers = nats_servers
-        self.nats_target = nats_target
 
     async def disconnected_cb(self):
         logger.info("Got disconnected from NATS!")
 
     async def reconnected_cb(self):
         # See who we are connected to on reconnect.
         logger.info("Got reconnected to NATS {url}".format(url=self.nc.connected_url))
@@ -101,27 +103,33 @@
             key=const.PubSubChannels.RESOURCE_NOTIFY.format(kbid=kbid),
             subscription_id=request_id,
         )
 
     def _get_notification_action_type(self):
         if has_feature(const.Features.WAIT_FOR_INDEX):
             return Notification.Action.INDEXED
-        return Notification.Action.COMMIT
+        return Notification.Action.COMMIT  # currently do not handle ABORT!
 
     async def wait_for_commited(
         self, kbid: str, waiting_for: WaitFor, request_id: str
     ) -> Optional[Event]:
         action_type = self._get_notification_action_type()
 
         def received(waiting_for: WaitFor, event: Event, raw_data: bytes):
             data = self.pubsub.parse(raw_data)
             pb = Notification()
             pb.ParseFromString(data)
             if pb.uuid == waiting_for.uuid and pb.action == action_type:
-                if waiting_for.seq is None or pb.seqid == waiting_for.seq:
+                if (
+                    waiting_for.seq is None
+                    or pb.seqid == waiting_for.seq
+                    # if we're waiting for index of this resource
+                    # the seq id will not match
+                    or action_type != Notification.Action.INDEXED
+                ):
                     event.set()
 
         waiting_event = Event()
         partial_received = partial(received, waiting_for, waiting_event)
         await self.pubsub.subscribe(
             handler=partial_received,
             key=const.PubSubChannels.RESOURCE_NOTIFY.format(kbid=kbid),
@@ -151,29 +159,36 @@
         try:
             await self.nc.drain()
         except nats.errors.ConnectionClosedError:
             pass
         await self.nc.close()
 
     async def commit(
-        self, writer: BrokerMessage, partition: int, wait: bool = False
+        self,
+        writer: BrokerMessage,
+        partition: int,
+        wait: bool = False,
+        target_subject: Optional[
+            str
+        ] = None,  # allow customizing where to send the message
     ) -> int:
         waiting_event: Optional[Event] = None
 
         waiting_for = WaitFor(uuid=writer.uuid)
         request_id = uuid.uuid4().hex
 
         if wait:
             waiting_event = await self.wait_for_commited(
                 writer.kbid, waiting_for, request_id=request_id
             )
 
-        res = await self.js.publish(
-            self.nats_target.format(partition=partition), writer.SerializeToString()
-        )
+        if target_subject is None:
+            target_subject = const.Streams.INGEST.subject.format(partition=partition)
+
+        res = await self.js.publish(target_subject, writer.SerializeToString())
 
         waiting_for.seq = res.seq
 
         if wait and waiting_event is not None:
             try:
                 await asyncio.wait_for(waiting_event.wait(), timeout=30.0)
             except asyncio.TimeoutError:
```

## nucliadb_utils/utilities.py

```diff
@@ -35,20 +35,22 @@
 from nucliadb_utils.cache.nats import NatsPubsub
 from nucliadb_utils.cache.pubsub import PubSubDriver
 from nucliadb_utils.cache.redis import RedisPubsub
 from nucliadb_utils.cache.settings import settings as cache_settings
 from nucliadb_utils.cache.utility import Cache
 from nucliadb_utils.exceptions import ConfigurationError
 from nucliadb_utils.indexing import IndexingUtility
+from nucliadb_utils.nats import NatsConnectionManager
 from nucliadb_utils.partition import PartitionUtility
 from nucliadb_utils.settings import (
     FileBackendConfig,
     audit_settings,
     nuclia_settings,
     storage_settings,
+    transaction_settings,
 )
 from nucliadb_utils.storages.settings import settings as extended_storage_settings
 from nucliadb_utils.store import MAIN
 
 if TYPE_CHECKING:  # pragma: no cover
     from nucliadb_utils.storages.local import LocalStorage
     from nucliadb_utils.storages.nuclia import NucliaStorage
@@ -72,14 +74,15 @@
     PUBSUB = "pubsub"
     INDEXING = "indexing"
     AUDIT = "audit"
     STORAGE = "storage"
     TRAIN = "train"
     TRAIN_SERVER = "train_server"
     FEATURE_FLAGS = "feature_flags"
+    NATS_MANAGER = "nats_manager"
 
 
 def get_utility(ident: Union[Utility, str]):
     return MAIN.get(ident)
 
 
 def set_utility(ident: Union[Utility, str], util: Any):
@@ -241,18 +244,44 @@
         elif hasattr(util, "finalize"):
             util.finalize()
         to_delete.append(key)
     for util in to_delete:
         clean_utility(util)
 
 
+async def start_transaction_utility(
+    service_name: Optional[str] = None,
+) -> TransactionUtility:
+    from nucliadb_utils.transaction import LocalTransactionUtility, TransactionUtility
+
+    if transaction_settings.transaction_local:
+        transaction_utility: Union[
+            LocalTransactionUtility, TransactionUtility
+        ] = LocalTransactionUtility()
+    elif transaction_settings.transaction_jetstream_servers is not None:
+        transaction_utility = TransactionUtility(
+            nats_creds=transaction_settings.transaction_jetstream_auth,
+            nats_servers=transaction_settings.transaction_jetstream_servers,
+        )
+        await transaction_utility.initialize(service_name)
+    set_utility(Utility.TRANSACTION, transaction_utility)
+    return transaction_utility  # type: ignore
+
+
 def get_transaction_utility() -> TransactionUtility:
     return get_utility(Utility.TRANSACTION)
 
 
+async def stop_transaction_utility() -> None:
+    transaction_utility = get_transaction_utility()
+    if transaction_utility:
+        await transaction_utility.finalize()
+        clean_utility(Utility.TRANSACTION)
+
+
 def get_indexing() -> IndexingUtility:
     return get_utility(Utility.INDEXING)
 
 
 def get_audit() -> Optional[AuditStorage]:
     return get_utility(Utility.AUDIT)
 
@@ -286,14 +315,43 @@
 async def stop_audit_utility():
     audit_utility = get_audit()
     if audit_utility:
         await audit_utility.finalize()
         clean_utility(Utility.AUDIT)
 
 
+async def start_nats_manager(
+    service_name: str, nats_servers: list[str], nats_creds: Optional[str] = None
+) -> NatsConnectionManager:
+    nats_manager = NatsConnectionManager(
+        service_name=service_name,
+        nats_servers=nats_servers,
+        nats_creds=nats_creds,
+    )
+    await nats_manager.initialize()
+    set_utility(Utility.NATS_MANAGER, nats_manager)
+    return nats_manager
+
+
+def get_nats_manager() -> NatsConnectionManager:
+    nats_manager = get_utility(Utility.NATS_MANAGER)
+    if nats_manager is None:
+        raise ConfigurationError("Nats manager not configured")
+    return nats_manager
+
+
+async def stop_nats_manager() -> None:
+    try:
+        nats_manager = get_nats_manager()
+    except ConfigurationError:
+        return
+    await nats_manager.finalize()
+    clean_utility(Utility.NATS_MANAGER)
+
+
 def get_feature_flags() -> featureflagging.FlagService:
     val = get_utility(Utility.FEATURE_FLAGS)
     if val is None:
         val = featureflagging.FlagService()
         set_utility(Utility.FEATURE_FLAGS, val)
     return val
```

## nucliadb_utils/tests/__init__.py

```diff
@@ -12,7 +12,17 @@
 # This program is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
+
+
+def free_port() -> int:
+    import socket
+
+    sock = socket.socket()
+    sock.bind(("", 0))
+    port = sock.getsockname()[1]
+    sock.close()
+    return port
```

## nucliadb_utils/tests/indexing.py

```diff
@@ -13,54 +13,26 @@
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 
-import nats
 import pytest
 
 from nucliadb_utils.indexing import IndexingUtility
 from nucliadb_utils.settings import indexing_settings
 from nucliadb_utils.utilities import Utility, clean_utility, get_utility, set_utility
 
 
-# Needs to be session to be executed at the begging
-@pytest.fixture(scope="function")
-async def cleanup_indexing(natsd):  # pragma: no cover
-    nc = await nats.connect(servers=[natsd])
-    js = nc.jetstream()
-
-    try:
-        await js.delete_consumer("node", "node-1")
-    except nats.js.errors.NotFoundError:
-        pass
-
-    try:
-        await js.delete_stream(name="node")
-    except nats.js.errors.NotFoundError:
-        pass
-
-    indexing_settings.index_jetstream_target = "node.{node}"
-    indexing_settings.index_jetstream_servers = [natsd]
-    indexing_settings.index_jetstream_stream = "node"
-    indexing_settings.index_jetstream_group = "node-{node}"
-    await nc.drain()
-    await nc.close()
-
-    yield
-
-
 @pytest.fixture(scope="function")
 async def indexing_utility_registered():  # pragma: no cover
     indexing_util = IndexingUtility(
         nats_creds=indexing_settings.index_jetstream_auth,
         nats_servers=indexing_settings.index_jetstream_servers,
-        nats_target=indexing_settings.index_jetstream_target,
     )
     await indexing_util.initialize()
     set_utility(Utility.INDEXING, indexing_util)
     yield
     await indexing_util.finalize()
     if get_utility(Utility.INDEXING):
         clean_utility(Utility.INDEXING)
```

## nucliadb_utils/tests/unit/test_transaction.py

```diff
@@ -33,15 +33,15 @@
         yield pubsub
 
 
 @pytest.fixture()
 async def txn(pubsub):
     nats_conn = mock.AsyncMock()
     with mock.patch("nucliadb_utils.transaction.nats.connect", return_value=nats_conn):
-        txn = TransactionUtility(nats_servers=["foobar"], nats_target="node.{node}")
+        txn = TransactionUtility(nats_servers=["foobar"])
         await txn.initialize()
         yield txn
         await txn.finalize()
 
 
 @pytest.mark.asyncio
 async def test_wait_for_commited(txn: TransactionUtility, pubsub):
```

## Comparing `nucliadb_utils-2.8.5.post247.dist-info/METADATA` & `nucliadb_utils-2.8.5.post249.dist-info/METADATA`

 * *Files 7% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: nucliadb-utils
-Version: 2.8.5.post247
+Version: 2.8.5.post249
 Summary: UNKNOWN
 Home-page: https://nuclia.com
 License: BSD
 Platform: UNKNOWN
 Classifier: Development Status :: 4 - Beta
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Topic :: Software Development :: Libraries :: Python Modules
@@ -12,17 +12,18 @@
 Requires-Dist: aiohttp (>=3.8.1)
 Requires-Dist: prometheus-client (>=0.12.0)
 Requires-Dist: types-requests (>=2.27.7)
 Requires-Dist: mmh3 (>=3.0.0)
 Requires-Dist: nats-py[nkeys] (==2.1.3)
 Requires-Dist: pyjwt (>=2.4.0)
 Requires-Dist: memorylru (>=1.1.2)
-Requires-Dist: nucliadb-protos (==2.8.5-post247)
+Requires-Dist: nucliadb-protos (==2.8.5-post249)
 Requires-Dist: nucliadb-telemetry (>=1.9.2)
 Requires-Dist: mrflagly
+Requires-Dist: urllib3 (<1.27,>=1.21.1)
 Provides-Extra: cache
 Requires-Dist: redis (>=4.3.4) ; extra == 'cache'
 Requires-Dist: orjson (>=3.6.7) ; extra == 'cache'
 Requires-Dist: lru-dict (>=1.1.7) ; extra == 'cache'
 Provides-Extra: fastapi
 Requires-Dist: fastapi (<0.89.0,>=0.75.0) ; extra == 'fastapi'
 Requires-Dist: uvicorn (<0.19.0,>=0.16.0) ; extra == 'fastapi'
```

## Comparing `nucliadb_utils-2.8.5.post247.dist-info/RECORD` & `nucliadb_utils-2.8.5.post249.dist-info/RECORD`

 * *Files 10% similar despite different names*

```diff
@@ -1,24 +1,24 @@
 nucliadb_utils/__init__.py,sha256=EvBCH1iTODe-AgXm48aj4kVUt_Std3PeL8QnwimR5wI,895
 nucliadb_utils/authentication.py,sha256=Ww3aTu1SrU0KvHZDSr14Ys_iplQXgAgA_GsdRDp51lY,5877
 nucliadb_utils/clandestined.py,sha256=impMwO7eLA-peRuY4nPqMtMLHWU1nZQC040SHC22XJg,4518
-nucliadb_utils/const.py,sha256=fLbrvH2KiHB5lTacOqmxi0dLa5eixOx2wGqOaB8bVqQ,1022
+nucliadb_utils/const.py,sha256=OoQoY2bBZ7we8heV8dYSAVf_VIfBTCEX68MzBWYznNw,1790
 nucliadb_utils/exceptions.py,sha256=o6UkFIq1jV1p7n3j73L4MyrGs9j3SJ2Fa-1hOH1KGhY,1138
-nucliadb_utils/featureflagging.py,sha256=T7xY_qy4I3wpWRr1do1OKCwFp2ogYfrp2C_C6RKfcgk,2130
+nucliadb_utils/featureflagging.py,sha256=q6EYBrue9kq3SFEGpBVUp5tY_OgmYmV642-c7Rh8WgU,2262
 nucliadb_utils/grpc.py,sha256=DJE9tQDvjUiiyF43F3Bsl5tfXmjO49l89IETfBOgCIo,2212
-nucliadb_utils/indexing.py,sha256=JSyNSzAbYthomDI2hvr9KaH9nGE7IURPZA0wAUNnzSc,3572
+nucliadb_utils/indexing.py,sha256=ceaHDDYCBrHXEVxgitRBY1--r5_XXl1Wzq4MvAsQWI0,3474
 nucliadb_utils/keys.py,sha256=fjumJHFoRaTbasLO5jZJ46xacAy-HqYAN-8Oquup75o,867
-nucliadb_utils/nats.py,sha256=YW4uMrgL0Ih3SMd5Yo_kHZtas86WXrKo-Nb7HQjEPR4,1519
+nucliadb_utils/nats.py,sha256=Cf9_6FvgYq_201m_X7TvjVI3j50iY01RDSENaGVCkP4,5993
 nucliadb_utils/partition.py,sha256=0tmXuwRM_v-OmKoRkB--OMDzomVEkmgxqMmNNomI_24,1173
 nucliadb_utils/py.typed,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 nucliadb_utils/run.py,sha256=bKMfsPEK6WdWfiPyWPUxCqcLo4tq6eOwyaf910TOwBk,1713
-nucliadb_utils/settings.py,sha256=3AG6HmXpYIiDXoRrd9YvuF7QZExuGvOCQodXCY9oIro,5028
+nucliadb_utils/settings.py,sha256=zJdxDQYyB-hq00p51Htt2jZZ9OR-rUEILEsDqqYQ9FU,4682
 nucliadb_utils/store.py,sha256=kQ35HemE0v4_Qg6xVqNIJi8vSFAYQtwI3rDtMsNy62Y,890
-nucliadb_utils/transaction.py,sha256=33nws7C8lCzxoG3UVUCVriM5nF41QCdIFLFNLKPBXn4,6131
-nucliadb_utils/utilities.py,sha256=7Qdf4mxtYoax8oZpR7A59O_wVfwqc7_Qko9AM6G7VGQ,11358
+nucliadb_utils/transaction.py,sha256=Zr5E02Y9lurbWOVRJi-gzTfvIl_0sxp8fsSuNX4cYsM,6621
+nucliadb_utils/utilities.py,sha256=TyWzs-8Epw44cPEWeXnHYHEKy7_1jH7UUPDVLEamWCg,13338
 nucliadb_utils/audit/__init__.py,sha256=cp15ZcFnHvpcu_5-aK2A4uUyvuZVV_MJn4bIXMa20ks,835
 nucliadb_utils/audit/audit.py,sha256=eZwbTaDHtEAqjtJ34eNuBtv05tK6XfcfcxWeGgOl4Z4,2013
 nucliadb_utils/audit/basic.py,sha256=V6bYvJqP9cvagrvnrYaym0aKpictP0XvL_s34S0YX68,2446
 nucliadb_utils/audit/stream.py,sha256=jZe2VbZ4dR5oRkfOnoOKsmEeQMqcUWMxsjccL7oJCW8,7688
 nucliadb_utils/cache/__init__.py,sha256=vVp-ZPp_aGpofI754T7E9JxsMkATqAEytangiKvE1Nk,900
 nucliadb_utils/cache/exceptions.py,sha256=Zu-O_-0-yctOEgoDGI92gPzWfBMRrpiAyESA62ld6MA,975
 nucliadb_utils/cache/memcache.py,sha256=CWd09BLh0K7vmxmj3Bhh0cLlCVeI_uvkzubqJpK7h0A,1216
@@ -36,33 +36,34 @@
 nucliadb_utils/storages/gcs.py,sha256=Rv8utP7ylINnV2YDrRM9bebFTbPtVPJuzynNsZ_S2HU,24880
 nucliadb_utils/storages/local.py,sha256=BHc3fG_aiKIVujlqKgig9EiCv5HrKzYCbdPhuhTR-Oc,10180
 nucliadb_utils/storages/nuclia.py,sha256=4qYM0sI9uYbURy-cKtWWiU13ojkWsgjZ8Z0V_cvv7Fo,2093
 nucliadb_utils/storages/pg.py,sha256=hvWZOhUJsboIMCvtFaDg4Dl8Mi5hkEBuYvuPFJESLhI,17174
 nucliadb_utils/storages/s3.py,sha256=LShMSeHJVTvS4xYlimFbKZvHQqaCOIJ7Wr1gsc9kJgc,15029
 nucliadb_utils/storages/settings.py,sha256=bUl3D7To-s3OVXPFFF7LwJbEKGF2WvDM14pwqQdkyoQ,1276
 nucliadb_utils/storages/storage.py,sha256=ogRpIfEJXDDdJywlicMyPbKerqr8NAEXE7BZMPvDUPI,17691
-nucliadb_utils/tests/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
+nucliadb_utils/tests/__init__.py,sha256=aeLpwHs9mc0m4xRGwUQH0W1yPJaDQfgZoiq1xfZ0Nt0,994
 nucliadb_utils/tests/asyncbenchmark.py,sha256=N3JoHpDyy2v-fvvn998cfbm4zFkGiaVkviW4WTiBO48,10691
 nucliadb_utils/tests/clandestined.py,sha256=33LlZprXXxxKKeRpDr3-10QU25_ztB23LFZCio83KVw,1043
 nucliadb_utils/tests/conftest.py,sha256=1eJEW4W8LToegBSrIQbxx64nI9o2xGipvpSKv7_zGsA,1686
 nucliadb_utils/tests/gcs.py,sha256=Pw0Gaza47uVaymn8VQ3Wxz-xhIv5_3twlxLqW8hl18g,2758
-nucliadb_utils/tests/indexing.py,sha256=EfgcUZzKBUlC-aYAE3CR65M7pQkZ0t_G7DdgdTqhz-U,2307
+nucliadb_utils/tests/indexing.py,sha256=YW2QhkhO9Q_8A4kKWJaWSvXvyQ_AiAwY1VylcfVQFxk,1513
 nucliadb_utils/tests/local.py,sha256=-oh0bHcTopSG84dYuNJo-66ICjil3sYFqEvmWlsSdnk,1310
 nucliadb_utils/tests/nats.py,sha256=iYoqn1bboFQ-SChe139aAHBH8jnnpIbSbY9CVozKK0I,7699
 nucliadb_utils/tests/s3.py,sha256=UTqn2Tm__yMSvoA8K80_j_LNf8Ip9bnVQbqyLeBAbvA,2216
 nucliadb_utils/tests/unit/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/tests/unit/test_authentication.py,sha256=grPHI9agbyMmsJFm_XhRXmDlKdEtvexvf5QDuuQGzH0,5159
 nucliadb_utils/tests/unit/test_clandestined.py,sha256=pTPcNT5XDWqR1EfmFSdTYpcaEnviXul-hXmL0Sr7wBA,14507
 nucliadb_utils/tests/unit/test_clandestined_collision.py,sha256=j9Y0lUIg4eDa4lSnlm4HAbbPAJiFwpeUbGXGWHBgqWc,1949
 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py,sha256=_H74r3QNKSy-dX6sifC0EpRJIeh1opkDM672UaznXSg,5303
+nucliadb_utils/tests/unit/test_nats.py,sha256=F-p4C4yUyQKIATFA4kkry0btqFnUd1yqHla5C5gDF5E,3083
 nucliadb_utils/tests/unit/test_run.py,sha256=VHeojVBj_AfV_uNch9eEi4zCT-O94VKjwb_O-UZgqpA,1910
 nucliadb_utils/tests/unit/test_tests.py,sha256=-YHgVMKJr_3WYwrBj9TnwpVLIkP80PLZpWnvAIYvnz8,1189
-nucliadb_utils/tests/unit/test_transaction.py,sha256=3yewzASOjQboA7hpsp-PeNn47QsZUf3qNFgCsWHy-nM,3435
+nucliadb_utils/tests/unit/test_transaction.py,sha256=la8d5ZyCOyWflPJ11Uz3OEFCJ7ARWF9YWrxToLKdjkI,3408
 nucliadb_utils/tests/unit/test_utilities.py,sha256=LO7QVMmx-jpeySJq7kLdyIR-G8fEYAAwHbQ8nioTvGI,5277
 nucliadb_utils/tests/unit/storages/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/tests/unit/storages/test_pg.py,sha256=KAIzD3QuJFMRNSSAKz-M5qrO9fJIHYbZfiOOleTgP1c,16726
 nucliadb_utils/tests/unit/storages/test_storage.py,sha256=kgZFXc-y_BX3HlcNHERzAkNPhNilXXQawIHBFq_5Q1k,5638
-nucliadb_utils-2.8.5.post247.dist-info/METADATA,sha256=1IOA-C7RGVpEfrSn_0Udv4cFF_JPWUo3jsnYkZJsuB8,1776
-nucliadb_utils-2.8.5.post247.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-nucliadb_utils-2.8.5.post247.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
-nucliadb_utils-2.8.5.post247.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
-nucliadb_utils-2.8.5.post247.dist-info/RECORD,,
+nucliadb_utils-2.8.5.post249.dist-info/METADATA,sha256=DeFtW52M0ztEwkENTxu_PYwoeKlyJm1WDw2gkNCCKw0,1816
+nucliadb_utils-2.8.5.post249.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+nucliadb_utils-2.8.5.post249.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
+nucliadb_utils-2.8.5.post249.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
+nucliadb_utils-2.8.5.post249.dist-info/RECORD,,
```

